name: ğŸš€ Trigger NGINX Build

on:
  workflow_dispatch:
    inputs:
      nginx_version:
        description: "Optional: NGINX version (leave empty to use latest)"
        required: false

jobs:
  trigger:
    name: ğŸ“¦ Prepare and Dispatch Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Determine NGINX Version
        id: set_version
        run: |
          VERSION="${{ github.event.inputs.nginx_version }}"
          echo "ğŸ“¥ Provided version: '${VERSION}'"
          if [ -z "$VERSION" ]; then
            echo "ğŸ“¡ No version specified. Fetching latest NGINX release from GitHub..."
            latest=$(curl -s https://api.github.com/repos/nginx/nginx/releases/latest | jq -r '.tag_name')
            echo "âœ… Using latest version: $latest"
            echo "nginx_version=$latest" >> "$GITHUB_ENV"
            echo "::set-output name=nginx_version::$latest"
          else
            echo "âœ… Using provided version: $VERSION"
            echo "nginx_version=$VERSION" >> "$GITHUB_ENV"
            echo "::set-output name=nginx_version::$VERSION"
          fi

      - name: ğŸ“¢ Announce Target Platforms
        run: |
          echo "ğŸ”§ NGINX Version to build: ${{ steps.set_version.outputs.nginx_version }}"
          echo "ğŸªŸ Windows build will be triggered"
          echo "ğŸ macOS build will be triggered"

      - name: ğŸš€ Dispatch Build to ci-bot
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: inckmolabs/ci-bot
          event-type: nginx-release
          client-payload: |
            {
              "nginx_version": "${{ steps.set_version.outputs.nginx_version }}"
            }

      - name: â³ Done! Waiting for Build Completion...
        run: |
          echo "ğŸ¯ Build job dispatched to ci-bot repository!"
          echo "ğŸ“¦ Targets: Windows (MSVC), macOS (Clang)"
