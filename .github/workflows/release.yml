name: 🚀 Trigger NGINX Build

on:
  workflow_dispatch:
    inputs:
      nginx_version:
        description: "Optional: NGINX version (leave empty to use latest)"
        required: false

jobs:
  trigger:
    name: 📦 Prepare and Dispatch Build
    runs-on: ubuntu-latest

    steps:
      - name: 🔍 Determine NGINX Version
        id: set_version
        run: |
          VERSION="${{ github.event.inputs.nginx_version }}"
          echo "📥 Provided version: '${VERSION}'"
          if [ -z "$VERSION" ]; then
            echo "📡 No version specified. Fetching latest NGINX release from GitHub..."
            latest=$(curl -s https://api.github.com/repos/nginx/nginx/releases/latest | jq -r '.tag_name')
            echo "✅ Using latest version: $latest"
            echo "nginx_version=$latest" >> "$GITHUB_ENV"
            echo "::set-output name=nginx_version::$latest"
          else
            echo "✅ Using provided version: $VERSION"
            echo "nginx_version=$VERSION" >> "$GITHUB_ENV"
            echo "::set-output name=nginx_version::$VERSION"
          fi

      - name: 📢 Announce Target Platforms
        run: |
          echo "🔧 NGINX Version to build: ${{ steps.set_version.outputs.nginx_version }}"
          echo "🪟 Windows build will be triggered"
          echo "🍎 macOS build will be triggered"

      - name: 🚀 Dispatch Build to ci-bot
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: inckmolabs/ci-bot
          event-type: nginx-release
          client-payload: |
            {
              "nginx_version": "${{ steps.set_version.outputs.nginx_version }}"
            }

      - name: ⏳ Done! Waiting for Build Completion...
        run: |
          echo "🎯 Build job dispatched to ci-bot repository!"
          echo "📦 Targets: Windows (MSVC), macOS (Clang)"
