name: ðŸš€ Zenon NGINX Release Dispatcher

on:
  workflow_dispatch:
    inputs:
      nginx_version:
        description: "Optional: NGINX version (leave blank for latest)"
        required: false

  release:
    types: [published]

jobs:
  prepare-and-dispatch:
    name: ðŸ“¦ Prepare and Dispatch Build
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Show Input Info
        run: |
          echo "ðŸ”§ Input Version: ${{ github.event.inputs.nginx_version || 'latest' }}"

      - name: ðŸ“¥ Set or Fetch Latest NGINX Version
        id: set-version
        run: |
          VERSION="${{ github.event.inputs.nginx_version }}"
          if [ -z "$VERSION" ]; then
            VERSION=$(gh release view nginx --repo nginx/nginx --json tagName -q .tagName)
          fi
          echo "nginx_version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: ðŸš€ Dispatch Multi-Platform Build
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: inckmolabs/ci-bot
          event-type: build-nginx
          client-payload: |
            {
              "nginx_version": "${{ steps.set-version.outputs.nginx_version }}"
            }

      - name: ðŸ“‹ Summary
        run: |
          echo "### Build Triggered ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ steps.set-version.outputs.nginx_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Platforms: Windows & macOS" >> $GITHUB_STEP_SUMMARY
