name: Trigger NGINX Build

on:
  release:
    types: [published]

  workflow_dispatch:
    inputs:
      nginx_version:
        description: "Optional: Specify NGINX version to build (leave blank for latest)"
        required: false
        default: ""

jobs:
  trigger-build:
    name: Trigger NGINX Build in ci-bot
    runs-on: ubuntu-latest

    steps:
      - name: Debug Print - Input Version
        run: |
          echo "ðŸ“¥ Provided version: '${{ github.event.inputs.nginx_version }}'"

      - name: Determine NGINX Version to Build
        id: version
        run: |
          if [ -z "${{ github.event.inputs.nginx_version }}" ]; then
            echo "ðŸ“¡ Fetching latest NGINX release from GitHub..."
            latest=$(curl -s https://api.github.com/repos/nginx/nginx/releases/latest | jq -r '.tag_name')
            echo "âœ… Using latest version: $latest"
            echo "nginx_version=$latest" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… Using provided version: ${{ github.event.inputs.nginx_version }}"
            echo "nginx_version=${{ github.event.inputs.nginx_version }}" >> "$GITHUB_OUTPUT"

      - name: Debug Print - Final Version
        run: |
          echo "ðŸš€ Version that will be sent to build: ${{ steps.version.outputs.nginx_version }}"

      - name: Trigger NGINX Build in ci-bot
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          repository: inckmolabs/ci-bot
          event-type: nginx-release
          client-payload: |
            {
              "nginx_version": "${{ steps.version.outputs.nginx_version }}"
            }

      - name: Cleanup Summary
        run: |
          echo "ðŸ§¹ Trigger completed. Version sent: ${{ steps.version.outputs.nginx_version }}"
